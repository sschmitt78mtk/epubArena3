<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>epubArena 3</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" href="{{ url_for('static',filename='gui3.css') }}">
    <style></style>
    <script>
        let logfileinfo_old = '';
        let apiConfigurations = [];

        function updateMessages() {
            fetch("/get_messages")
                .then(response => response.json())
                .then(data => {
                    text2show = (data.log_last_10_lines); // .replace('<br/>','\r\n');
                    let logfileinfo = document.getElementById("logfileinfo");
                    if (!logfileinfo.matches(':hover')) { // nur aktualisieren, wenn man nicht gerade darin scrollt
                        logfileinfo.innerHTML  = text2show;
                        logfileinfo_old = text2show;
                        logfileinfo.scrollTop = logfileinfo.scrollHeight;
                        logfileinfo.style.backgroundColor = "#f9f9f9"; 
                    } else {
                        if (logfileinfo_old !== text2show) {
                            logfileinfo.style.backgroundColor = "#ffffcc"; // Gelb
                        }   
                    }
                });
        }

        let prompt_json;
        let activePrompt1 = 0
        let activePrompt2 = 1
        let promptlength = 0

        function getPrompts() {
            fetch("/get_prompts")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('Prompt-Daten erhalten:', data);
                    prompt_json = data.prompts;
                    promptlength = data.count;
                    activePrompt1 = data.activePrompt1;
                    activePrompt2 = data.activePrompt2;
                    setprompt(1, activePrompt1)
                    setprompt(2, activePrompt2)
                })
                .catch(error => {
                    console.error('Fetch-Fehler:', error);
                });
        }

        function setprompt(SumTran, promptno) {
            epromptno = promptno
            for (var i = 0; i < promptlength; i++) {
                // console.log('promptsearch' + prompt_json[i].PromptID + ' ?  ' + i)
                if (prompt_json[i].PromptID == promptno) {
                    // console.log('promptmatch ' + promptno + ' -> ' + i)
                    epromptno = i;
                    break;
                }
            }
            // PromptID
            document.getElementById(`promptno_${SumTran}`).value = prompt_json[epromptno].PromptID
            // System Prompt
            document.getElementById(`system_prompt_${SumTran}`).innerText = prompt_json[epromptno].system_message
            // Pre prompt
            document.getElementById(`pre_prompt_${SumTran}`).innerText = prompt_json[epromptno].prePrompt
            // Post prompt
            document.getElementById(`post_prompt_${SumTran}`).innerText = prompt_json[epromptno].postPrompt
            // Info
            document.getElementById(`info_prompt_${SumTran}`).innerText = prompt_json[epromptno].infostr
            // Max new token
            document.getElementById(`maxnewtoken_${SumTran}`).value = prompt_json[epromptno].maxNewToken
            // Temperature
            document.getElementById(`temp_${SumTran}`).value = prompt_json[epromptno].temperature
            // [Unused] - Top P
            // document.getElementById(`top_p_${SumTran}`).value = prompt_json[epromptno].top_p
            // Allowing long answers
            document.getElementById(`allow_long_answer_${SumTran}`).checked = prompt_json[epromptno].allowLongAnswer
        }

        async function loadAPIConfigOptions() {
            try {
                console.log('loadAPIConfigOptions()')
                const response = await fetch("/get_api_configs");
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                apiConfigurations = data.configs;
                
                // Populate dropdown
                const select = document.getElementById('api_config_select');
                select.innerHTML = '<option value="">-- API Configuration laden --</option>';
                
                apiConfigurations.forEach((config, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = config.name || `Config ${index + 1}`;
                    console.log(option.textContent);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading API configurations:', error);
            }
        }

        // Overwrite fields when configuration is selected
        function loadAPIConfig(configIndex) {
            if (configIndex === '' || configIndex === null) return;
            
            const config = apiConfigurations[configIndex];
            if (!config) return;
            
            // Overwrite all API fields with selected configuration
            document.getElementById('current_openai_api_base').value = config.OPENAI_API_BASE || '';
            document.getElementById('current_openai_api_key').value = config.OPENAI_API_KEY || '';
            document.getElementById('current_open_api_modelname').value = config.OPEN_API_MODELNAME || '';
            document.getElementById('modelname').value = config.modelname || '';
        }

        // verhindert erneutes Senden des Form bei Neuladen
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        };

    </script>
</head>

<body>
    <div class="site-header">
        <div class="logo">epubArena 3</div>
        <nav class="site-nav">
            <a href="{{ url_for('uploadfile') }}">Upload</a>
            <a href="#downloads-section">Downloads</a>
            <a href="{{ url_for('edit_prompts') }}">Prompts bearbeiten</a>
        </nav>
    </div>
    <h2>epubArena 3</h2>
    <form method="POST">
        <div class="container">
            <div id="topleft" class="card">
                <label class="description">GePubFilename: {{ gePubFilename }}</label>
                <br>
                <label class="description" for="api_config_select">Load API Config:</label>
                <select id="api_config_select" class="nameinput" onchange="loadAPIConfig(this.value)">
                    <option value="">-- Select Configuration --</option>
                </select>
                <br>
                <label class="description" for="current_openai_api_base">current_openai_api_base:</label>
                <input type="text" class="nameinput" id="current_openai_api_base" name="current_openai_api_base" value="{{ current_openai_api_base }}"><br/>
                <label class="description" for="current_openai_api_key">current_openai_api_key:</label>
                <input type="text" class="nameinput apikey" id="current_openai_api_key" name="current_openai_api_key" value="{{ current_openai_api_key }}"><br/>
                <label class="description" for="current_open_api_modelname">current_open_api_modelname:</label>
                <input type="text" class="nameinput" id="current_open_api_modelname" name="current_open_api_modelname" value="{{ current_open_api_modelname }}"><br/>

                <label class="description" for="modelname">Modelname:</label>
                <input type="text" class="nameinput" id="modelname" name="modelname" value="{{ modelname }}"><br/>
                <label class="description" for="modelname_translation">Modelname (translation):</label>
                <input type="text" class="nameinput" id="modelname_translation" name="modelname_translation" value="{{ modelname_translation }}"><br/>
                <label class="description" for="source4prompt2">source4prompt2:</label>
                <input type="text" class="nameinput" id="source4prompt2" name="source4prompt2" value="{{ source4prompt2 }}"><br/>

                <label class="description" for="ce_start">start</label>
                <input type="number" class="numberinput" name="ce_start" id="ce_start" value="{{ ce_start }}" min="0">
                <label class="description" for="ce_stop">stop</label>
                <input type="number" class="numberinput" name="ce_stop" id="ce_stop" value="{{ ce_stop }}" min="0"><br/>

                <input type="checkbox" name="translate_heading" id="translate_heading" {% if translate_heading %}checked{% endif %}>
                <label for="translate_heading">translate_heading</label><br/>
                <input type="checkbox" name="batch_jobs" id="batch_jobs" {% if batch_jobs %}checked{% endif %}>
                <label for="batch_jobs">batch_jobs (Alle epub-Dateien in 'input')</label><br/>
                <input type="checkbox" name="force_redo" id="force_redo" {% if force_redo %}checked{% endif %}>
                <label for="force_redo">force_redo</label><br/>
                <input type="checkbox" name="publish_only" id="publish_only" {% if publish_only %}checked{% endif %}>
                <label for="publish_only">publish_only</label><br/>
                <input type="checkbox" name="use_markdown" id="use_markdown" {% if use_markdown %}checked{% endif %}>
                <label for="use_markdown">use_markdown</label><br/>
                <input type="checkbox" name="llm_from_file" id="llm_from_file" {% if llm_from_file %}checked{% endif %}>
                <label for="llm_from_file">llm_from_file</label><br/>
                <input type="checkbox" name="use_langchain" id="use_langchain" {% if use_langchain %}checked{% endif %}>
                <label for="use_langchain">use_langchain</label><br/>

                <label for="chunker_maxp" class="description">chunker_maxp</label>
                <input type="number" class="numberinput" name="chunker_maxp" id="chunker_maxp" value="{{ chunker_maxp }}" min="0">
                <label for="chunker_maxwords" class="description">chunker_maxwords</label>
                <input type="number" class="numberinput" name="chunker_maxwords" id="chunker_maxwords" value="{{ chunker_maxwords }}" min="0"><br/>
            </div>

            <div id="topright">
                <div id="logfileinfodiv"><p id="logfileinfo"></p></div>
            </div>
	</div>
    <div id="cinema1">

        <a href="{{ url_for('edit_prompts') }}">Prompts bearbeiten</a>

        <!-- Tabelle mit Textareas -->
        <table width="100%" cellspacing="2" cellpadding="2" border="1">
            <tr>
                <th>Aktiv</th>
                <th>Nr</th>
                <th>System Prompt</th>
                <th>Pre-Prompt</th>
                <th>Post-Prompt</th>
                <th>Info</th>
                <th>maxToken</th>
                <th>Temp</th>
                <th>Erlaube<br>lange Antwort</th>
            </tr>
            <tr>
                <td><input type="checkbox" name="use_summary" id="use_summary" checked></td>
                <td class="narrowtd">No_<input class="numberinput" type="text" id="promptno_1" name="promptno_1" value="55" readonly>
                    <button type="button" onclick="prev(1)">↑</button>
                    <button type="button" onclick="next(1)">↓</button>
                </td>
                <td><textarea class="promptinput readonly" id="system_prompt_1" name="system_prompt_1" rows="3" readonly>system_prompt_1</textarea></td>
                <td><textarea class="promptinput readonly" id="pre_prompt_1" name="pre_prompt_1" rows="3" readonly>pre_prompt_1</textarea></td>
                <td><textarea class="promptinput readonly" id="post_prompt_1" name="post_prompt_1" rows="3" readonly>post_prompt_1</textarea></td>
                <td><textarea class="promptinput readonly" id="info_prompt_1" name="info_prompt_1" rows="3" readonly>info_prompt_1</textarea></td>
                <td><input type="number" class="numberinput readonly" name="maxnewtoken_1" id="maxnewtoken_1" value="999" min="0" readonly></td>
                <td><input type="number" class="numberinput readonly" name="temp_1" id="temp_1" value="0.1" min="0" max="5" step="0.1" readonly></td>
                <td><input type="checkbox" name="allow_long_answer_1" id="allow_long_answer_1" checked readonly></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="use_translation" id="use_translation" checked></td>
                <td class="narrowtd">No_<input class="numberinput" type="text" id="promptno_2" name="promptno_2" value="199" readonly>
                    <button type="button" onclick="prev(2)">↑</button>
                    <button type="button" onclick="next(2)">↓</button>
                </td>
                <td><textarea class="promptinput readonly" id="system_prompt_2" name="system_prompt_2" rows="3" readonly>system_prompt_2</textarea></td>
                <td><textarea class="promptinput readonly" id="pre_prompt_2" name="pre_prompt_2" rows="3" readonly>pre_prompt_2</textarea></td>
                <td><textarea class="promptinput readonly" id="post_prompt_2" name="post_prompt_2" rows="3" readonly>post_prompt_2</textarea></td>
                <td><textarea class="promptinput readonly" id="info_prompt_2" name="info_prompt_2" rows="3" readonly>info_prompt_2</textarea></td>
                <td class="narrowtd"><input type="number" class="numberinput readonly" name="maxnewtoken_2" id="maxnewtoken_2" value="998" min="0" readonly></td>
                <td class="narrowtd"><input type="number" class="numberinput readonly" name="temp_2" id="temp_2" value="0.2" min="0" max="5" step="0.1" readonly></td>
                <td class="narrowtd"><input type="checkbox" name="allow_long_answer_2" id="allow_long_answer_2" checked readonly</td>
            </tr>

        </table>
        </div>
        <div id="cinema2">
        <br>
        <button class="startstopbutton" type="submit" name="start">START</button>
    </form>
    <form method="POST">
        <button class="startstopbutton" type="submit" name="stop">STOP</button>
    </form>
    <form method="POST" onsubmit="return confirmDelete()">
        <br>
        <label class="description" for="modeltodelete">translation modelname to delete:</label>
        <input type="text" class="modeltodelete" id="modeltodelete" name="modeltodelete" value="{{modeltodelete}}"><br>
        <button class="deletebutton" type="submit" name="delete">DELETE</button>
    </form>
</div>
    
    <!-- EPUB Downloads Section -->
    <div id="downloads-section">
        <h3>EPUB Downloads</h3>
        <button type="button" onclick="refreshDownloads()" class="refresh-button">Liste aktualisieren</button>
        <div id="downloads-list">
            <p>Lade EPUB-Dateien...</p>
        </div>
    </div>
    
    <p id="statusrow"></p>
    
    <script>
        function prev(a) {
            const isFirst = a === 1;
            let epromptno = isFirst ? activePrompt1 : activePrompt2;
            epromptno = epromptno === 0 ? promptlength - 1 : epromptno - 1;
            setprompt(a, epromptno);
            if (isFirst) {
                activePrompt1 = epromptno;
            } else {
                activePrompt2 = epromptno;
            }
        }

        function next(a) {
            const isFirst = a === 1;
            let epromptno = isFirst ? activePrompt1 : activePrompt2;
            epromptno = epromptno === promptlength - 1 ? 0 : epromptno + 1;
            setprompt(a, epromptno);
            if (isFirst) {
                activePrompt1 = epromptno;
            } else {
                activePrompt2 = epromptno;
            }
        }

        function confirmDelete() {
            return confirm("Die Übersetzung wirklich löschen?");
        }

        // EPUB Download Functions
        function refreshDownloads() {
            fetch("/list_epub_files")
                .then(response => response.json())
                .then(data => {
                    const downloadsList = document.getElementById("downloads-list");
                    downloadsList.innerHTML = "";
                    
                    if (data.files.length === 0) {
                        downloadsList.innerHTML = "<p>Keine EPUB-Dateien verfügbar.</p>";
                        return;
                    }
                    
                    data.files.forEach(file => {
                        const fileSize = formatFileSize(file.size);
                        const modifiedDate = new Date(file.modified * 1000).toLocaleString();
                        
                        const fileItem = document.createElement("div");
                        fileItem.className = "download-item";
                        fileItem.innerHTML = `
                            <span class="filename">${file.name}</span>
                            <span class="fileinfo">${fileSize} - ${modifiedDate}</span>
                            <a href="/download/${encodeURIComponent(file.name)}" class="download-button">Download</a>
                        `;
                        downloadsList.appendChild(fileItem);
                    });
                })
                .catch(error => {
                    console.error("Error fetching EPUB files:", error);
                    document.getElementById("downloads-list").innerHTML = "<p>Fehler beim Laden der Dateiliste.</p>";
                });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return "0 Bytes";
            const k = 1024;
            const sizes = ["Bytes", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
        }

        setInterval(updateMessages, 2000); // Nachrichten alle 2 Sekunden abrufen
        getPrompts();
        loadAPIConfigOptions();
        refreshDownloads(); // Load EPUB files on page load

    </script>
</body>

</html>
